function geneDialog(e) {
    var t = {
        xlj: {
            id: "xlj",
            name: "寻麓君",
            avatar: "img/avatar.png"
        }
    };
    _members = $.extend(_members, t),
    _dialog.d0 = [
        {
            type: "system",
            content: myTime
        }, {
            type: "plain",
            author: _members.xlj,
            content: "筑梦十年，不忘初心，1月22日，麓湖年会诚邀各位“同麓人”共同庆祝，欢迎您的到来！首先我需要您提供【姓名】好安排定制服务。"
        }
    ],
    _dialog.d3 = [
        {
            type: "system"
        }, {
            type: "plain",
            author: _members.xlj,
            content: "好的，感谢您的支持，筑梦十年感谢有您，新的一年，准备好一起出发了吗？1月22日，我们不见不散。",
            pause: 2e3
        }, {
            type: "plain",
            author: _members.xlj,
            content: "关于具体的年会时间、地点等安排，我们制作了一份精美的邀请函，请您打开查阅。",
            pause: 1500
        }, {
            type: "picture",
            author: _members.xlj,
            content: "img/poster-sm.png"
        }
    ],
    _dialog.d4 = [
        {
            type: "picture",
            author: _members.xlj,
            content: "img/final-sm.png"
        }
    ],
    _dialog.name = [
        {
            type: "system",
            content: myTime
        }, {
            type: "plain",
            author: _members.me,
            content: "hello"
        }
    ],
    _dialog.phone = [
        {
            type: "plain",
            author: _members.me,
            content: "hello"
        }
    ],
    _dialog.confirm = [
        {
            type: "plain",
            author: _members.me,
            content: "hello"
        }
    ],
    _dialog.r1 = [
        {
            type: "plain",
            author: _members.xlj
        }
    ],
    _dialog.r2 = [
        {
            type: "plain",
            author: _members.xlj
        }
    ],
    _dialog.r3 = [
        {
            type: "picture",
            author: _members.xlj
        }
    ]
}
function Queue() {}
function copyQueue(e) {
    for (var t = new Queue, n = 0; n < e.length; n++)
        t.add(e[n]);
    return t
}
function activeInput(e) {
    $(".box_ft").find("input").prop({
        disabled: !1,
        placeholder: e
    })
}
function deactiveInput() {
    $(".box_ft").find("input").prop({
        disabled: !0,
        placeholder: "",
        value: ""
    }),
    $(".input-wrapper").removeClass("send-ready")
}
function showDialog(e, t) {
    function n(e) {
        void 0 == e && (e = 1e3 * Math.random() + 600);
        var a = setTimeout(function() {
            if (i) {
                var e = o([i.el]);
                $chat.append(e);
                var r = $(".J_scrollContent").height(),
                    u = $chat.height();
                if (u > r && $(".J_scrollContent").scrollSmooth(u - r + 16, 300), i.el.flag) {
                    var l = i.el.flag;
                    switch (l) {
                        case "animate-tour":
                            playTour()
                    }
                }
                void 0 != i.el.pause
                    ? n(i.el.pause)
                    : n(),
                i = i._next
            } else
                clearTimeout(a),
                t && t()
        }, e)
    }
    deactiveInput();
    var i = copyQueue(e)._first,
        o = doT.template($("#messageTpl").html());
    n(0)
}
function timer() {
    var e = $("#js_callTime"),
        n = t++;
    n <= 16 && (n < 10
        ? e.html("0" + n)
        : e.html(n), window.setTimeout("timer()", 1e3))
}
function myRight(e, t) {
    return ("0" + e).substr(-t)
}
function myDay(e) {
    var t = [
        "日",
        "一",
        "二",
        "三",
        "四",
        "五",
        "六"
    ];
    return "星期" + t[e]
}
function trim(e) {
    return e.replace(/(^\s*)|(\s*$)/g, "")
}
function getWx(e) {
    var t = 0;
    return $.ajax({
        url: "http://192.168.16.166:1125/UIHandler/UIHandler1.ashx",
        data: {
            action: "RetrieveEmployee",
            openid: openid,
            name: e
        },
        dataType: "json",
        async: !1,
        type: "post",
        success: function(e) {
            t = e,
            console.log(e)
        },
        error: function() {}
    }),
    t
}
function getCookie(e) {
    var t,
        n = new RegExp("(^| )" + e + "=([^;]*)(;|$)");
    return (t = document.cookie.match(n))
        ? unescape(t[2])
        : null
}
var me = {
        id: "me",
        name: decodeURIComponent(getCookie("WxNickName")) || "麓湖的朋友",
        avatar: getCookie("WxHeadImg") || "img/avatar-me.png",
        userId: "",
        registered: !1
    },
    _userName = me.name,
    _inputName = "",
    _inputPhone = "",
    _dialog = {},
    _members = {},
    myTime = (new Date).toLocaleTimeString(),
    status = "",
    openid = "",
    init = function() {
        var e = ZMD_COMMON.parseURI().params;
        status = e.status,
        openid = e.WxOpenId,
        console.log(e)
    }();
$.fn.scrollSmooth = function(e, t) {
    function n() {
        var e = Math.min(1, (Date.now() - u) / t);
        o.scrollTop = r * e + a + 20,
        e < 1 && setTimeout(n, 10)
    }
    var i = this,
        o = i[0],
        a = o.scrollTop,
        r = e - a,
        u = Date.now();
    n()
},
$.fn.goSmooth = function(e, t) {
    function n() {
        var e = Math.min(1, (Date.now() - r) / t);
        i.css("margin-bottom", a * e + o),
        e < 1 && setTimeout(n, 10)
    }
    var i = this,
        o = 1 * i.css("margin-bottom").replace("px", ""),
        a = e - o,
        r = Date.now();
    n()
};
var $chat = $("#chatContent");
Queue.prototype = {
    add: function(e) {
        return this._last
            ? this._last = this._last._next = {
                el: e,
                _next: null
            }
            : this._last = this._first = {
                el: e,
                _next: null
            },
        this
    }
},
$(function() {
    if ("ios" == judge.platform()) {
        var e = "<style> body{ font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif!important;}</style>";
        $("head").append(e)
    }
    if ("android" == judge.platform()) {
        var e = "<style>body{ font-family: 'RobotoRegular', 'Droid Sans', sans-serif!important;}</style>";
        $("head").append(e)
    }
    pageSwitch(),
    _members.me = me,
    geneDialog(_userName)
});
var pageSwitch = function() {
        $("#js_call").click(function() {
            $("#js_phone").hide(),
            $("#js_calling").show(),
            ion.sound.play("phonecall"),
            window.setTimeout("timer()", 1e3)
        }),
        $("#js_hang").click(function() {
            $("#js_calling").hide(),
            $("#js_message").show(),
            ion.sound.stop("phonecall")
        }),
        $(".msg-hint").click(function() {
            $("#js_message").hide(),
            $("#js_chat").show(),
            $("body").attr("ontouchmove", "return true"),
            1 == status
                ? mainThread.completeInfo()
                : mainThread.intro()
        })
    },
    phoneCall = function() {
        ion.sound({
            sounds: [
                {
                    name: "phonecall",
                    volume: 1,
                    preload: !0
                }
            ],
            path: "sounds/",
            ended_callback: function() {
                $("#js_hang>i").addClass("animated infinite tada"),
                $("#js_timer").html("通话结束，请挂断电话").addClass("animated infinite fadeIn")
            }
        })
    }(),
    t = 1,
    c,
    myDate = new Date;
$("#js_time").html(myRight(myDate.getHours(), 2) + ":" + myRight(myDate.getMinutes(), 2)),
$("#js_date").html(myRight(myDate.getMonth() + 1, 2) + "月" + myRight(myDate.getDate(), 2) + "日 " + myDay(myDate.getDay()));
var mainThread = {
        intro: function() {
            showDialog(_dialog.d0, function() {
                0 == status && window.mainThread.getName()
            })
        },
        getName: function() {
            activeInput("请输入您的姓名"),
            $("#js_input").on("keyup", function(e) {
                if (_inputName = trim($("#js_input").val()), "" === _inputName && null === _inputName || ($(".input-wrapper").addClass("send-ready"), $("#js_submit").unbind("click").click(function() {
                    _inputName = trim($("#js_input").val()),
                    submitName()
                })), 13 == e.which) {
                    if ("" != _inputName && null != _inputName)
                        return _inputName = trim($("#js_input").val()),
                        void submitName();
                    alert("请正确输入姓名")
                }
            })
        },
        getPhone: function(e) {
            _dialog.r1[0].content = "好的，【" + e + "】, 为了避免万华的大家庭里有同名同姓的情况，我还需要进一步确认您的身份，请提供您的【电话号码】。",
            showDialog(_dialog.r1, function() {
                activeInput("请输入您的电话号码"),
                $("#js_input").on("keyup", function(e) {
                    if (13 == e.which) {
                        _inputPhone = trim($("#js_input").val());
                        var t = /^(13[0-9]|15[0|3|6|7|8|9]|18[8|9])\d{8}$/;
                        if (!t.test(_inputPhone))
                            return alert("请正确输入手机号"),
                            !1;
                        _dialog.phone[0].content = _inputPhone,
                        showDialog(_dialog.phone, function() {
                            deactiveInput(),
                            $("#js_input").off("keyup"),
                            window.mainThread.vertifyInfo(_inputName, _inputPhone)
                        })
                    }
                })
            })
        },
        vertifyInfo: function(e) {
            _dialog.r2[0].content = "【" + e + "】，请确认您的信息是否输入正确？请回复【是】或【不是】",
            showDialog(_dialog.r2, function() {
                activeInput("确认您的信息");
                var t;
                $("#js_input").on("keyup", function(n) {
                    if (t = $("#js_input").val(), "" === t && null === t || ($(".input-wrapper").addClass("send-ready"), $("#js_submit").unbind("click").click(function() {
                        t = $("#js_input").val(),
                        submitVertify(e, t)
                    })), 13 == n.which) {
                        if ("" == t || null == t)
                            return alert("请正确输入"),
                            !1;
                        t = $("#js_input").val(),
                        submitVertify(e, t)
                    }
                })
            })
        },
        queryInfo: function(e) {
            var t = getWx(e);
            1 == t || 5 == t
                ? window.mainThread.completeInfo()
                : 4 == t && (_dialog.r2[0].content = "此账户已绑定！", showDialog(_dialog.r2, function() {
                    window.mainThread.completeInfo()
                }))
        },
        completeInfo: function() {
            _dialog.d3[0].content = (new Date).toLocaleTimeString(),
            showDialog(_dialog.d3, function() {
                $(".J_img").on("click", function() {
                    $(".poster").addClass("show");
                    var e = $(".poster").find("img"),
                        t = e.height(),
                        n = $(window).height();
                    e.on("touchmove", function() {
                        var e = Math.abs($(this).offset().top),
                            i = (t - n) / 2;
                        console.log(i),
                        e >= i && $(".arrow-down").removeClass("infinite bounce").addClass("fadeOut")
                    })
                })
            })
        }
    },
    submitName = function() {
        _dialog.name[1].content = _inputName,
        showDialog(_dialog.name, function() {
            deactiveInput(),
            $("#js_input").off("keyup"),
            window.mainThread.vertifyInfo(_inputName)
        })
    },
    submitVertify = function(e, t) {
        _dialog.confirm[0].content = t,
        showDialog(_dialog.confirm, function() {
            deactiveInput(),
            $("#js_input").off("keyup"),
            "是" === t
                ? window.mainThread.queryInfo(e)
                : "不是" === t
                    ? window.mainThread.intro()
                    : "是" !== t && "不是" !== t && window.mainThread.vertifyInfo(e)
        })
    };
document.querySelector("form").addEventListener("submit", function(e) {
    e.preventDefault()
});
